#!/bin/bash

echo "Creating Mageia container on Docker Hub"

# Workdir
if [ _"$HOME" = _"" ]; then
	echo "Please define HOME to a sensible value"
	exit -1
fi
GITDIR=$HOME/prj/mageia-docker
OFFDIR=$HOME/prj/official-images
WORKDIR=$HOME/tmp

# What is our current date
DATE=`date "+%Y-%m-%d"`

# Mageia version to consider
# Other value could be 4 or cauldron
MGAVER=5

MGAMIRROR="ftp://ftp.home.musique-ancienne.org/pub/mageia/distrib"
#MGAMIRROR="ftp://distrib-coffee.ipsl.jussieu.fr/pub/linux/Mageia/distrib"
MGAARCH=x86_64

# Accept CLI param to overwrite default version of Mageia
if [ _"$1" != _"" ]; then
	MGAVER=$1
fi

echo "Cleanup $WORKDIR/$MGAVER and $GITDIR first for idempotence"
sudo rm -rf $WORKDIR/$MGAVER

cd $GITDIR
git checkout master
if [ $? -ne 0 ]; then
	echo "Unable to checkout branch master"
	exit -1
fi
git branch -D $MGAVER 
if [ $? -ne 0 ]; then
	echo "Unable to delete branch $MGAVER"
	exit -1
fi
git checkout --orphan $MGAVER
if [ $? -ne 0 ]; then
	 echo "Unable to create branch $MGAVER"
	exit -1
fi
git rm --cached -r .

echo "Creating the appropriate Docker file"
cat > Dockerfile << EOF
FROM scratch
MAINTAINER bcornec@mageia.org
ADD mageia-$MGAVER-$DATE.tar.xz /
LABEL name="Mageia $MGAVER Base Image" \
    vendor="Mageia" \
    license="GPLv2" \
    build-date="$DATE"
CMD /bin/bash
EOF

echo "Creating the chroot with latest Mageia content"
sudo /usr/sbin/urpmi.addmedia --distrib --urpmi-root $WORKDIR/$MGAVER $MGAMIRROR/$MGAVER/$MGAARCH 2>&1 >/dev/null
sudo /usr/sbin/urpmi -q --auto --no-recommends --urpmi-root $WORKDIR/$MGAVER basesystem urpmi 2>&1 >/dev/null

echo "Capturing that chroot content into mageia-$MGAVER-$DATE.tar.xz"
sudo rm -f mageia-$MGAVER-$DATE.tar.xz
sudo tar -C $WORKDIR/$MGAVER -cJf mageia-$MGAVER-$DATE.tar.xz .
sudo chmod 644 mageia-$MGAVER-$DATE.tar.xz

echo "Generating the docker image mageiaofficial:$MGAVER from it"
docker build -t mageiaofficial:$MGAVER . 2>&1 >/dev/null
docker images mageiaofficial:$MGAVER

echo "Commiting into our git repo"
git lfs track "*.tar.xz"
git add .gitattributes
git add mageia-$MGAVER-$DATE.tar.xz Dockerfile mageia-docker
git commit -m "update Mageia $MGAVER - $DATE"
CID=`git show | head -1 | cut -d' ' -f2`
echo "New commit ID for latest commit is $CID"
git push -f --set-upstream origin $MGAVER
git checkout master

cd $OFFDIR/library
git remote update
perl -p -e 'undef $/; s|(/5\nGitCommit:) [a-f0-9]+|$1 '$CID'|' mageia
git add mageia
git commit -m "update Mageia commit ID to $CID"
git push origin
